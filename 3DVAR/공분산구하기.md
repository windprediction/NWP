여기서 핵심은 **3DVAR 목적 함수**

$$
J(x)=\frac{1}{2}(x-x_b)^T B^{-1}(x-x_b)+\frac{1}{2}(y-H(x))^T R^{-1}(y-H(x))
$$

를 풀 때 쓰이는 **B(배경 오차 공분산)**, **R(관측 오차 공분산)**, 그리고 이 항들이 어떻게 작동하는지입니다.

---

### **1. 공분산 행렬 B (배경 오차 공분산)**

```python
B = torch.diag(torch.tensor([1.5, 1.0, 2.0]))  # 배경 오차
```

* 대각 행렬(diagonal matrix) 형태로 단순화했습니다.
* 각 변수(기온, 바람, 상대습도)의 **모델 예측(x\_b) 불확실성**을 나타냄.

  * `1.5`: 기온 예측 불확실성 (°C)
  * `1.0`: 풍속 예측 불확실성 (m/s)
  * `2.0`: 상대습도 예측 불확실성 (%)
* 실제 운영 3DVAR에서는 **NMC 방법**(예보 시간차의 통계 분석)이나 **앙상블 스프레드**로 B를 추정하지만,
  여기선 단순히 가중치 역할로만 사용.

이 행렬은 첫 번째 항

$$
\frac{1}{2}(x-x_b)^T B^{-1}(x-x_b)
$$

에서 모델 예측과의 차이를 패널티로 주는 역할을 합니다.
즉, **모델이 믿을 만하다면(B 값이 작을 때)** 분석값(x)이 x\_b와 크게 벗어나기 어렵습니다.

---

### **2. 공분산 행렬 R (관측 오차 공분산)**

```python
R = torch.diag(torch.tensor([0.5, 0.3, 1.0]))  # 관측 오차
```

* 각 관측 데이터(y)의 \*\*신뢰도(정확도)\*\*를 나타냄.

  * `0.5`: 기온 관측 불확실성 (±0.5°C)
  * `0.3`: 풍속 관측 불확실성 (±0.3 m/s)
  * `1.0`: 상대습도 관측 불확실성 (±1%)
* 두 번째 항

$$
\frac{1}{2}(y-H(x))^T R^{-1}(y-H(x))
$$

에서 관측과 분석값(x)의 차이에 대한 패널티를 줍니다.
즉, **관측이 믿을 만하다면(R 값이 작을 때)** 분석값(x)이 관측(y)에 가까워지도록 유도합니다.

---

### **3. H 연산자**

```python
H = lambda z: z  # 단순 보간만 적용
```

* 모델 공간의 상태(x)를 관측 공간(y)으로 변환하는 연산자.
* 실제 LDAPS 3DVAR에서는:

  * AWS 지점 → 2m 기온/10m 바람으로 변환 (경계층 모형 사용)
  * 위성 → 복사전달모델(RTTOV)로 휘도온도 변환
  * 라디오존데 → 수직 보간 수행
* 여기서는 단순히 **모델 격자에서 최근접 값을 가져오기만** 하므로 Identity(항등)로 설정.

---

### **4. 목적 함수와 최적화**

```python
term1 = (x - x_b).unsqueeze(0) @ torch.inverse(B) @ (x - x_b).unsqueeze(1)
term2 = (y - Hx).unsqueeze(0) @ torch.inverse(R) @ (y - Hx).unsqueeze(1)
```

* `term1`: **배경장과 분석값의 차이** (모델을 벗어나면 패널티)
* `term2`: **관측과 분석값의 차이** (관측과 동화되지 않으면 패널티)

둘을 합쳐서 **가중 평균을 찾는 문제**로 변환합니다.
가중치는 B와 R의 역행렬로 주어져, \*\*불확실성이 작은 쪽(신뢰도 높은 쪽)\*\*이 분석값을 더 많이 당깁니다.

---

### **5. L-BFGS 최적화**

```python
optimizer = torch.optim.LBFGS([x], lr=0.1, max_iter=50)
```

* L-BFGS (quasi-Newton) 알고리즘으로 J(x)를 최소화해 \*\*분석값(x\*)\*\*을 찾습니다.
* 초기값은 배경장(x\_b), 최적화 후 **관측과 모델의 절충값**이 됩니다.

---

### **결과적으로**

* **B와 R의 상대 크기**에 따라 결과가 바뀝니다:

  * B가 작고 R이 크면 → 모델(x\_b)을 더 믿어서 관측의 영향이 작아짐.
  * R이 작고 B가 크면 → 관측(y)을 더 믿어서 분석값이 관측 쪽으로 크게 이동.
* 현재 설정은 온도는 관측을 더 믿고, 바람과 습도는 모델 쪽 가중치가 더 큽니다.

